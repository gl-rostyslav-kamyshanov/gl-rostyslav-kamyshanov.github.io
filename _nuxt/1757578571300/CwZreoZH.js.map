{"version":3,"file":"CwZreoZH.js","sources":["../../../../app/utils/sleep.ts","../../../../app/pages/auth/login/index.vue"],"sourcesContent":["export const sleep = (interval: number): Promise<void> => new Promise(resolve => setTimeout(resolve, interval));\n","<script setup lang=\"ts\">\nimport { breakpointsTailwind, useBreakpoints } from \"@vueuse/core\";\nimport useAsync from \"~/composables/use-async\";\nimport { AUTH_METHOD } from \"~/constants\";\nimport AuthAPI from \"~/services/auth\";\nimport useUserStore from \"~/stores/user\";\nimport { base64ToString } from \"~/utils/base64\";\nimport { onDeviceLimitError } from \"~/utils/device\";\nimport getErrorLocalePathMessage from \"~/utils/locale\";\nimport { sleep } from \"~/utils/sleep\";\nimport V from \"~/utils/validate\";\n\nconst { t, te } = useI18n();\nconst route = useRoute();\nconst router = useRouter();\nconst userStore = useUserStore();\nconst appConfig = useRuntimeConfig().public;\n\nconst formData = reactive({\n  username: (route.query.email as string) || \"\",\n  password: \"\",\n});\ntype State = typeof formData;\n\nfunction validate(data: State): IFormError[] {\n  const errs: IFormError[] = [];\n  const state = unref(data);\n\n  if (!V.required(state.username)) {\n    errs.push({ path: \"username\", message: t(\"errors.field_is_required\") });\n  }\n  else if (!V.email(state.username)) {\n    errs.push({ path: \"username\", message: t(\"errors.invalid_email\") });\n  }\n\n  if (!V.required(state.password)) {\n    errs.push({ path: \"password\", message: t(\"errors.field_is_required\") });\n  }\n  else if (!V.min(state.password, { length: 8 })) {\n    errs.push({ path: \"password\", message: t(\"errors.invalid_password\") });\n  }\n\n  return errs;\n}\nconst hasIfaAuth = appConfig.APP_FLAGS.hasIfaAuth;\nconst deviceLimitNewFlow = appConfig.APP_FLAGS.deviceLimitNewFlow;\n\nconst onSuccess = async () => {\n  if (hasIfaAuth) {\n    window.location.href = \"/\";\n    return;\n  }\n  router.push((route.query.redirectUrl as string) || \"/\");\n};\n\nconst onError = (error: Error) => {\n  const err = error as Error & { code?: string; token: string; provider: TAuthProvider };\n\n  if (err.code === \"device_limit_exceeded\") {\n    if (deviceLimitNewFlow) {\n      userStore.logout();\n      router.push({ path: \"/auth/login/\", query: { deviceNoLongerAllowedError: \"true\" } });\n    }\n    else {\n      onDeviceLimitError(err.token, err.provider, { username: formData.username, password: formData.password });\n    }\n  }\n};\nconst {\n  loading: loginLoading,\n  error,\n  run: executeLogin,\n} = useAsync(AuthAPI.signin, { onSuccess, onError });\nconst {\n  loading: socialLoginLoading,\n  error: socialError,\n  run: executeSocialLogin,\n} = useAsync(AuthAPI.signinWithProvider, { onSuccess, onError });\n\nconst loading = computed(() => loginLoading.value || socialLoginLoading.value);\nconst onSubmit = () => {\n  if (route.query.sessionExpired || route.query.deviceNoLongerAllowedError) {\n    router.replace({\n      query: {\n        ...route.query,\n        sessionExpired: undefined,\n        deviceNoLongerAllowedError: undefined,\n      },\n    });\n  }\n\n  return executeLogin(formData.username, formData.password, AUTH_METHOD.SIGN_IN);\n};\n\nasync function onPasswordResetSuccess() {\n  await sleep(5000);\n\n  route.query.passwordResetSuccess\n  && router.push({ query: { ...route.query, passwordResetSuccess: undefined } });\n}\n\nasync function onAutoLogin() {\n  if (!route.query.data)\n    return;\n\n  try {\n    const data = JSON.parse(base64ToString(route.query.data as string));\n    if (data.provider === \"credentials\") {\n      formData.username = data.username;\n      formData.password = data.password;\n      onSubmit();\n    }\n    else {\n      executeSocialLogin(data.provider);\n    }\n  }\n  catch (err: any) {\n    error.value = err && err.message;\n  }\n}\n\nconst errorMessage = computed(() => {\n  if (route.query.deviceNoLongerAllowedError)\n    return t(\"pages.auth_login.device_no_longer_allowed_error\");\n\n  if (route.query.sessionExpired)\n    return t(\"errors.expired_session_error\");\n\n  if (error.value)\n    return getErrorLocalePathMessage(error.value, { t, te }).message;\n\n  if (socialError.value)\n    return getErrorLocalePathMessage(socialError.value, { t, te }).message;\n\n  return null;\n});\nconst breakpoints = useBreakpoints(breakpointsTailwind);\nconst sm = breakpoints.greaterOrEqual(\"sm\");\n\nonMounted(() => {\n  onPasswordResetSuccess();\n  onAutoLogin();\n});\n\nuseHead({ title: computed(() => t(\"labels.sign_in\")) });\ndefinePageMeta({ layout: \"auth\" });\n</script>\n\n<template>\n  <AuthHeader :mode=\"hasIfaAuth ? undefined : 'sign-up'\" :fixed=\"!sm\" :absolute=\"sm\" transparent class=\"my-2 sm:my-0\" with-locale />\n\n  <BaseMain>\n    <div class=\"flex flex-col items-center justify-center h-screen sm:pt-0 px-4 sm:px-0\">\n      <div class=\"w-full max-w-[25rem]\">\n        <h1 class=\"whitespace-pre-wrap text-heading-1-bold text-center sm:text-left\">\n          {{ t('pages.auth_sign_in.welcome_message') }}\n        </h1>\n\n        <template v-if=\"hasIfaAuth\">\n          <p class=\"mt-4 text-caption-medium text-secondary\">\n            {{ t(\"pages.auth_sign_in.sign_in_with_provider\", { provider: 'IFA' }) }}\n          </p>\n          <BaseAlert\n            v-if=\"errorMessage\"\n            type=\"danger\"\n            class=\"mt-6\"\n            :text=\"errorMessage\"\n          />\n\n          <BaseButton\n            style=\"--base-primary-accent-color: #2c374b\"\n            class=\"relative mt-8 text-button-bold\"\n            name=\"ifa\"\n            full-width\n            :disabled=\"socialLoginLoading\"\n            @click=\"executeSocialLogin('ifa')\"\n          >\n            <BaseImage\n              class=\"absolute top-2.5 left-3\" src=\"/images/icons/icon-ifa-logo.webp\"\n              fallback-src=\"/images/mock/logo.svg\" alt=\"Logo\" :width=\"24\" :height=\"24\"\n            />\n            {{ t('labels.continue_with', { provider: 'IFA' }) }}\n          </BaseButton>\n        </template>\n\n        <template v-else>\n          <p class=\"mt-4 text-caption-medium text-secondary text-center sm:text-left\">\n            {{ t(\"pages.auth_sign_up.enter_your_details_below\") }}\n          </p>\n\n          <BaseAlert\n            v-if=\"errorMessage\"\n            type=\"danger\"\n            class=\"mt-6\"\n            :text=\"errorMessage\"\n          />\n          <BaseAlert\n            v-if=\"route.query.passwordResetSuccess\"\n            type=\"success\"\n            class=\"mt-6\"\n            :text=\"t('pages.auth_sign_up.password_updated_successuly_text')\"\n          />\n\n          <UForm :state=\"formData\" :validate=\"validate\" class=\"mt-8\" @submit=\"onSubmit\">\n            <div class=\"flex flex-col gap-2 sm:gap-6\">\n              <UFormGroup\n                :label=\"t('labels.email')\"\n                name=\"username\"\n                required\n              >\n                <BaseInput\n                  v-model=\"formData.username\"\n                  :disabled=\"loading\"\n                  name=\"email\"\n                  :placeholder=\"t('labels.email_placeholder')\"\n                  autocomplete=\"email\"\n                />\n              </UFormGroup>\n\n              <UFormGroup\n                :label=\"t('labels.password')\"\n                required\n                name=\"password\"\n              >\n                <BaseInput\n                  v-model=\"formData.password\"\n                  :disabled=\"loading\"\n                  :placeholder=\"t('labels.min_8_characters')\"\n                  name=\"password\"\n                  autocomplete=\"new-password\"\n                  sensitive\n                />\n              </UFormGroup>\n            </div>\n\n            <div class=\"mt-2 flex flex-col gap-8\">\n              <BaseButton\n                name=\"forgot-password\"\n                tag=\"nuxt-link\"\n                class=\"text-sm\"\n                :to=\"{\n                  path: '/auth/password/forgot/',\n                  query: { email: formData.username },\n                }\"\n                :disabled=\"loading\"\n                link\n              >\n                {{ t(\"labels.forgot_password\") }}?\n              </BaseButton>\n              <BaseButton\n                class=\"font-bold\"\n                name=\"submit-login\"\n                :disabled=\"loading || socialLoginLoading\"\n                full-width\n              >\n                {{ t(\"labels.sign_in\") }}\n              </BaseButton>\n            </div>\n          </UForm>\n\n          <AuthProviderButtons\n            :disabled=\"socialLoginLoading\"\n            @click-provider=\"executeSocialLogin\"\n          />\n        </template>\n      </div>\n      <AuthTerms class=\"text-center\" />\n    </div>\n  </BaseMain>\n</template>\n"],"names":["sleep","interval","resolve","t","te","useI18n","route","useRoute","router","useRouter","userStore","useUserStore","appConfig","useRuntimeConfig","formData","reactive","validate","data","errs","state","unref","V","hasIfaAuth","deviceLimitNewFlow","onSuccess","onError","error","err","onDeviceLimitError","loginLoading","executeLogin","useAsync","AuthAPI","socialLoginLoading","socialError","executeSocialLogin","loading","computed","onSubmit","AUTH_METHOD","onPasswordResetSuccess","onAutoLogin","base64ToString","errorMessage","getErrorLocalePathMessage","sm","useBreakpoints","breakpointsTailwind","onMounted","useHead","_createVNode","_component_AuthHeader","_unref","_component_BaseMain","_createElementVNode","_hoisted_1","_hoisted_2","_hoisted_3","_toDisplayString","_createElementBlock","_Fragment","_hoisted_4","_createBlock","_component_BaseAlert","_component_BaseButton","_component_BaseImage","_createTextVNode","_hoisted_5","_component_UForm","_hoisted_6","_component_UFormGroup","_component_BaseInput","_cache","$event","_hoisted_7","_component_AuthProviderButtons","_component_AuthTerms"],"mappings":"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"}