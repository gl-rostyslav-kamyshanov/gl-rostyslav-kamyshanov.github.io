import{av as l,e as a,aw as g,a as n,r as m}from"./vfF7RKPo.js";import{N as i}from"./DrHYGv5w.js";import{f as h}from"./BW4JKS41.js";import{g as w}from"./C_PxQ261.js";const d=e=>{const r=e.expireMonth&&e.expireYear?`${e.expireMonth}/${String(e.expireYear).substring(2)}`:"";return{id:e.id??"",cardHolderName:e.displayName??"",cardNumber:e.number??"",cardExpiration:r,cardCVV:"",cardType:e.type}},f=e=>({id:e._id,title:e.title,description:e.description,price:e.price,currency:e.currency||"N/A",startDate:e.startDate,endDate:e.endDate,isActive:e.active,autoRenew:e.autoRenew,type:e.type,originalProductId:e.originalProductId,lastPayment:e.lastPayment||0}),C=e=>{const r=o=>h(o,"d.L.yyyy"),t=w(e.price,e.currency);return{id:e.details.orderId,date:r(e.date),name:e.title,type:e.details.productType,amount:t}};function u(){const e=l(),r=i(()=>e.$mercadopago),t=i(()=>r.value!==null&&r.value!==void 0);return{mercadopago:r,isAvailable:t}}const p=e=>{const r=n();r.creditCard=e},c={load(){const e=n();if(e.creditCard)return Promise.resolve(e.creditCard);const{request:r}=a();return r.get("/api/payment/user_method_info").then(t=>Object.keys(t.content).length!==0?(e.creditCard=d(t.content),d(t.content)):null)},loadHistory(e){const{request:r}=a();return r.get("/api/commerce/billing_history",{query:e}).then(t=>m(t,C))},update(e){const{request:r}=a(),t={card:{token:e}};return r.post("/api/commerce/set_billing_info",{body:t}).then(o=>p(d(o.content)))},delete(){const{request:e}=a(),r=n(),t={card_id:r.creditCard?.id,user_id:r.user?.id};return e.post("/api/payment/delete_method",{body:t}).then(()=>p(null))},redeemAccessCode(e){const{request:r}=a();return r.post("/api/commerce/redeem_code",{body:{code:e}}).then(t=>f(t.content))},purchase(e){const{request:r}=a();return r.post("/api/payment/purchase",{body:e})},async createMercadoPagoCardToken(e){const r=n(),{mercadopago:t}=u();if(!t.value)throw new Error("ERR400GN00");try{const o=await t.value.createCardToken(e);if(!o)throw new Error("ERR400GN00");return r.creditCardToken=o.id,o.id}catch(o){throw new Error(o.message)}},async updateMercadoPagoCardToken(e){const r=n(),{mercadopago:t}=u();if(!t.value)throw new Error("ERR400GN00");try{const o=await t.value.updateCardToken(e);if(!o)throw new Error("ERR400GN00");return r.creditCardToken=o.id,o.id}catch(o){throw new Error(o.message)}},async payWithMercadoPagoWithUpdatedToken(e,r){try{const t=await c.updateMercadoPagoCardToken(r);await c.purchase({productId:e,token:t})}catch(t){throw new Error(t.message)}},async payWithMercadoPagoCreditCard(e,r){try{const t=await c.createMercadoPagoCardToken(r);await c.purchase({productId:e,token:t})}catch(t){throw new Error(t.message)}},initPayment(e,r,t="en"){const{request:o}=a(),y={productId:e,callbackUrl:r,language:t};return o.post("/api/payment/initialize",{body:y}).then(s=>(g.set(`transactionId_${e}`,s.content.transactionId,{expires:new Date(new Date().getTime()+300*1e3),sameSite:"strict"}),s.content.authorizationUrl)).then(s=>{window.location.href=s})},verifyTransaction(e){const{request:r}=a(),t={transactionId:e};return r.post("/api/payment/verify",{body:t})},confirmProcessingPayment(e){const{request:r}=a(),t={transactionId:e};return r.post("/api/payment/confirm_processing",{body:t})}};export{c as B,u};
