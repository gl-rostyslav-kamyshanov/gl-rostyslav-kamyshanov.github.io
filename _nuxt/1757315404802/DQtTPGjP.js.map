{"version":3,"file":"DQtTPGjP.js","sources":["../../../../app/components/Icon/spinner/Blade2.vue","../../../../app/composables/use-socket-io/use-payment-socket.ts","../../../../app/pages/payment/processing.vue"],"sourcesContent":["<script setup lang=\"ts\">\n/* eslint-disable max-len */\nexport interface IconSpinnerCircleProps {\n  size?: number;\n}\n\nconst props = withDefaults(defineProps<IconSpinnerCircleProps>(), { size: 40 });\n</script>\n\n<template>\n  <svg\n    xmlns=\"http://www.w3.org/2000/svg\"\n    :width=\"props.size\"\n    :height=\"props.size\"\n    viewBox=\"0 0 24 24\"\n  ><g><rect width=\"2\" height=\"5\" x=\"11\" y=\"1\" fill=\"currentColor\" opacity=\".14\" /><rect width=\"2\" height=\"5\" x=\"11\" y=\"1\" fill=\"currentColor\" opacity=\".29\" transform=\"rotate(30 12 12)\" /><rect width=\"2\" height=\"5\" x=\"11\" y=\"1\" fill=\"currentColor\" opacity=\".43\" transform=\"rotate(60 12 12)\" /><rect width=\"2\" height=\"5\" x=\"11\" y=\"1\" fill=\"currentColor\" opacity=\".57\" transform=\"rotate(90 12 12)\" /><rect width=\"2\" height=\"5\" x=\"11\" y=\"1\" fill=\"currentColor\" opacity=\".71\" transform=\"rotate(120 12 12)\" /><rect width=\"2\" height=\"5\" x=\"11\" y=\"1\" fill=\"currentColor\" opacity=\".86\" transform=\"rotate(150 12 12)\" /><rect width=\"2\" height=\"5\" x=\"11\" y=\"1\" fill=\"currentColor\" transform=\"rotate(180 12 12)\" /><animateTransform attributeName=\"transform\" calcMode=\"discrete\" dur=\"0.75s\" repeatCount=\"indefinite\" type=\"rotate\" values=\"0 12 12;30 12 12;60 12 12;90 12 12;120 12 12;150 12 12;180 12 12;210 12 12;240 12 12;270 12 12;300 12 12;330 12 12;360 12 12\" /></g></svg>\n</template>\n","import type { Socket } from \"socket.io-client\";\nimport { SOCKET_EVENT } from \"./index\";\n\ninterface IPaymentStatus {\n  product: string;\n  status: \"APPROVED\" | \"FAILED\";\n}\n\ninterface Options {\n  onSuccess?: () => void;\n  onError?: (err: Error) => void;\n}\n\nexport default function usePaymentSocket(socket?: Socket | null, options?: Options) {\n  if (!socket) {\n    return;\n  }\n\n  socket.on(SOCKET_EVENT.USER_PURCHASE_STATUS, ({ status }: IPaymentStatus) => {\n    status === \"APPROVED\" ? options?.onSuccess?.() : options?.onError?.(new Error(\"Payment Failed!\"));\n  });\n}\n","<script setup lang=\"ts\">\nimport Cookies from \"js-cookie\";\nimport useAsync from \"~/composables/use-async\";\nimport useSocketIO, { SOCKET_EVENT } from \"~/composables/use-socket-io\";\nimport usePaymentSocket from \"~/composables/use-socket-io/use-payment-socket\";\nimport BillingAPI from \"~/services/billing\";\n\nconst { t } = useI18n();\nconst route = useRoute();\nconst router = useRouter();\nconst socket = useSocketIO();\nconst runtimeConfig = useRuntimeConfig().public;\nconst isSyncPaymentFlow = !runtimeConfig.APP_CUSTOMER.enable_async_payment_flow;\nconst paymentTimeout = Math.abs(runtimeConfig.APP_CUSTOMER.payment_timeout) * 1000;\n\nconst customSuccessRedirectURL = runtimeConfig.APP_CUSTOMER.success_payment_redirect_url;\nconst subscriptionId = runtimeConfig.APP_CUSTOMER.subscription_id;\n\nconst productId = route.query.productId as string;\nconst redirectURL = route.query.redirectURL as string;\nconst title = route.query.title as string;\n\nconst shouldCustomRedirect = customSuccessRedirectURL && (subscriptionId === productId);\n\nconst loading = ref(true);\nconst timeoutId = ref<NodeJS.Timeout | null>(null);\n\nconst { run: verifyTransaction } = useAsync(BillingAPI.verifyTransaction, { onSuccess, onError });\nconst { run: confirmProcessingPayment } = useAsync(BillingAPI.confirmProcessingPayment);\n\nfunction onSuccess() {\n  if (productId) {\n    Cookies.remove(`transactionId_${productId}`);\n  }\n\n  if (shouldCustomRedirect) {\n    const url = new URL(customSuccessRedirectURL);\n\n    return window.location.href = url.toString();\n  }\n\n  loading.value = false;\n\n  if (customSuccessRedirectURL && (subscriptionId === productId)) {\n    const url = new URL(customSuccessRedirectURL);\n\n    return window.location.href = url.toString();\n  }\n\n  router.push({\n    path: \"/payment/success/\",\n    query: { title, productId, redirectURL },\n  });\n};\n\nfunction onError() {\n  if (productId) {\n    Cookies.remove(`transactionId_${productId}`);\n  }\n\n  loading.value = false;\n\n  router.push({\n    path: \"/payment/failure/\",\n    query: { productId, redirectURL },\n  });\n};\n\nasync function handlePayment() {\n  const transactionId = Cookies.get(`transactionId_${productId}`);\n\n  if (isSyncPaymentFlow) {\n    return verifyTransaction(transactionId);\n  }\n\n  if (transactionId) {\n    await confirmProcessingPayment(transactionId);\n  }\n\n  await Promise.race([\n    new Promise<void>((resolve) => {\n      usePaymentSocket(socket, { onSuccess: () => {\n        onSuccess();\n        resolve();\n      }, onError: () => {\n        onError();\n        resolve();\n      } });\n    }),\n    new Promise((resolve) => {\n      timeoutId.value = setTimeout(resolve, paymentTimeout);\n    }),\n  ]);\n\n  if (transactionId) {\n    verifyTransaction(transactionId);\n  }\n}\n\nonMounted(handlePayment);\n\nonBeforeUnmount(() => {\n  socket?.off(SOCKET_EVENT.USER_PURCHASE_STATUS);\n\n  if (timeoutId.value) {\n    clearTimeout(timeoutId.value);\n  }\n});\n\ndefinePageMeta({ layout: \"auth\", middleware: \"auth\" });\n</script>\n\n<template>\n  <AuthHeader transparent absolute />\n\n  <BaseMain class=\"!h-[calc(100%-25px)]\">\n    <div class=\"flex px-4 items-center justify-center flex-col h-full\">\n      <div class=\"w-full max-w-[400px]\">\n        <div class=\"flex flex-col justify-center items-center\">\n          <div class=\"flex flex-col justify-center items-center gap-6\">\n            <div v-if=\"loading\" class=\"flex justify-center items-center size-16 bg-[var(--base-card-bgColor)] rounded-full\">\n              <IconSpinnerBlade2 :size=\"24\" />\n            </div>\n\n            <div class=\"flex flex-col justify-center items-center gap-4\">\n              <h1 class=\"text-3xl font-bold\">\n                {{ t('pages.account_billing.payment_in_progress') }}\n              </h1>\n\n              <p class=\"text-center text-[var(--base-secondary-color)] font-medium\">\n                {{ shouldCustomRedirect ? t('pages.account_billing.payment_in_progress_message_2') : t('pages.account_billing.payment_in_progress_message') }}\n              </p>\n            </div>\n\n            <BaseButton\n              v-if=\"!shouldCustomRedirect\"\n              name=\"subscribe\"\n              type=\"primary\"\n              class=\"font-bold\"\n              tag=\"nuxt-link\"\n              :to=\"{ path: redirectURL || '/' }\"\n            >\n              {{ t('labels.back_to_site') }}\n            </BaseButton>\n          </div>\n        </div>\n      </div>\n    </div>\n  </BaseMain>\n</template>\n"],"names":["props","__props","_createElementBlock","usePaymentSocket","socket","options","SOCKET_EVENT","status","useI18n","route","useRoute","router","useRouter","useSocketIO","runtimeConfig","useRuntimeConfig","isSyncPaymentFlow","paymentTimeout","customSuccessRedirectURL","subscriptionId","productId","redirectURL","title","shouldCustomRedirect","loading","ref","timeoutId","verifyTransaction","useAsync","BillingAPI","onSuccess","onError","confirmProcessingPayment","Cookies","url","handlePayment","transactionId","resolve","onMounted","onBeforeUnmount","_createVNode","_component_AuthHeader","_component_BaseMain","_createElementVNode","_hoisted_1","_hoisted_2","_hoisted_3","_hoisted_4","_unref","_openBlock","_hoisted_5","_component_IconSpinnerBlade2","_hoisted_6","_hoisted_7","_toDisplayString","_hoisted_8","_createBlock","_component_BaseButton"],"mappings":"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"}