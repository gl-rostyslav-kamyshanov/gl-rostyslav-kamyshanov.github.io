{"version":3,"file":"CTDD6-J7.js","sources":["../../../../app/pages/auth/oauth2/callback/[provider].vue"],"sourcesContent":["<!-- eslint-disable max-len -->\n<script setup lang=\"ts\">\nimport AuthAPI, { handleAuthResponse } from \"~/services/auth\";\nimport { fetchIFAAccessToken } from \"~/services/auth/ifa\";\nimport useUserStore from \"~/stores/user\";\nimport getErrorLocalePathMessage from \"~/utils/locale\";\n\nconst { t, te } = useI18n();\nconst route = useRoute();\nconst router = useRouter();\nconst userStore = useUserStore();\n\nconst authorizationCode = route.query.code as string;\nconst provider = route.params.provider as TAuthProvider;\nconst error = ref<Error | null>(null);\nconst loading = ref(false);\nconst localizedError = computed(() => error.value && getErrorLocalePathMessage(error.value.message, { t, te }).message);\nconst deviceLimitNewFlow = useRuntimeConfig().public.APP_FLAGS.deviceLimitNewFlow;\nconst postMessageToOpener = (message: { error?: string; success?: boolean; access_token?: string }) => {\n  if (!window.opener)\n    return;\n\n  window.opener.postMessage(message, window.opener.location);\n};\nconst onError = (err: Error & { code?: string; token?: string; provider?: TAuthProvider }) => {\n  if (!window.opener) {\n    if (err.code && err.code === \"device_limit_exceeded\") {\n      if (deviceLimitNewFlow) {\n        userStore.logout();\n        router.push({ path: \"/auth/login/\", query: { deviceNoLongerAllowedError: \"true\" } });\n      }\n      else {\n        onDeviceLimitError(err.token, err.provider);\n      }\n    }\n\n    error.value = err;\n    return;\n  }\n\n  postMessageToOpener({ error: JSON.stringify(err) });\n};\nconst onSuccess = (response: IResponseSSOLogin) => {\n  handleAuthResponse(response, provider);\n\n  if (!window.opener) {\n    router.push(\"/\");\n    return;\n  }\n  postMessageToOpener({ success: true });\n};\n\nconst handleAuthorization = async () => {\n  loading.value = true;\n\n  if (!authorizationCode || !provider) {\n    const error = new Error(\"Invalid authorization code or provider\");\n    onError(error);\n    return;\n  }\n\n  try {\n    const { access_token } = await fetchIFAAccessToken(authorizationCode);\n    if (window.opener) {\n      postMessageToOpener({ access_token });\n      return;\n    }\n\n    const providerResponse = formatProviderResponse(access_token, provider);\n\n    AuthAPI.signSSO(providerResponse)\n      .then(onSuccess)\n      .catch(onError);\n  }\n  catch (err) {\n    onError(err as Error);\n  }\n  finally {\n    loading.value = false;\n  }\n};\n\nonMounted(handleAuthorization);\n</script>\n\n<template>\n  <div class=\"main-container text-main flex justify-center items-center gap-4\">\n    <!-- eslint-disable-next-line max-len -->\n    <div v-if=\"loading\" class=\"inline-block h-8 w-8 animate-spin rounded-full border-2 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]\" role=\"status\">\n      <span\n        class=\"!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]\"\n      />\n    </div>\n    <BaseAlert v-if=\"localizedError\" type=\"danger\" :text=\"localizedError\" />\n  </div>\n</template>\n"],"names":["t","te","useI18n","route","useRoute","router","useRouter","userStore","useUserStore","authorizationCode","provider","error","ref","loading","localizedError","computed","getErrorLocalePathMessage","deviceLimitNewFlow","useRuntimeConfig","postMessageToOpener","message","onError","err","onDeviceLimitError","onSuccess","response","handleAuthResponse","onMounted","access_token","fetchIFAAccessToken","providerResponse","formatProviderResponse","AuthAPI","_openBlock","_createElementBlock","_hoisted_1","_unref","_hoisted_2","_cache","_createElementVNode","_createBlock","_component_BaseAlert"],"mappings":"2fAOA,KAAM,CAAE,EAAAA,EAAG,GAAAC,CAAA,EAAOC,EAAA,EACZC,EAAQC,EAAA,EACRC,EAASC,EAAA,EACTC,EAAYC,EAAA,EAEZC,EAAoBN,EAAM,MAAM,KAChCO,EAAWP,EAAM,OAAO,SACxBQ,EAAQC,EAAkB,IAAI,EAC9BC,EAAUD,EAAI,EAAK,EACnBE,EAAiBC,EAAS,IAAMJ,EAAM,OAASK,EAA0BL,EAAM,MAAM,QAAS,CAAE,EAAAX,EAAG,GAAAC,CAAA,CAAI,EAAE,OAAO,EAChHgB,EAAqBC,EAAA,EAAmB,OAAO,UAAU,mBACzDC,EAAuBC,GAA0E,CAChG,OAAO,QAGZ,OAAO,OAAO,YAAYA,EAAS,OAAO,OAAO,QAAQ,CAC3D,EACMC,EAAWC,GAA6E,CAC5F,GAAI,CAAC,OAAO,OAAQ,CACdA,EAAI,MAAQA,EAAI,OAAS,0BACvBL,GACFV,EAAU,OAAA,EACVF,EAAO,KAAK,CAAE,KAAM,eAAgB,MAAO,CAAE,2BAA4B,MAAA,EAAU,GAGnFkB,EAAmBD,EAAI,MAAOA,EAAI,QAAQ,GAI9CX,EAAM,MAAQW,EACd,MACF,CAEAH,EAAoB,CAAE,MAAO,KAAK,UAAUG,CAAG,EAAG,CACpD,EACME,EAAaC,GAAgC,CAGjD,GAFAC,EAAmBD,EAAUf,CAAQ,EAEjC,CAAC,OAAO,OAAQ,CAClBL,EAAO,KAAK,GAAG,EACf,MACF,CACAc,EAAoB,CAAE,QAAS,GAAM,CACvC,EAgCA,OAAAQ,EA9B4B,SAAY,CAGtC,GAFAd,EAAQ,MAAQ,GAEZ,CAACJ,GAAqB,CAACC,EAAU,CACnC,MAAMC,EAAQ,IAAI,MAAM,wCAAwC,EAChEU,EAAQV,CAAK,EACb,MACF,CAEA,GAAI,CACF,KAAM,CAAE,aAAAiB,CAAA,EAAiB,MAAMC,EAAoBpB,CAAiB,EACpE,GAAI,OAAO,OAAQ,CACjBU,EAAoB,CAAE,aAAAS,EAAc,EACpC,MACF,CAEA,MAAME,EAAmBC,EAAuBH,EAAclB,CAAQ,EAEtEsB,EAAQ,QAAQF,CAAgB,EAC7B,KAAKN,CAAS,EACd,MAAMH,CAAO,CAClB,OACOC,EAAK,CACVD,EAAQC,CAAY,CACtB,QAAA,CAEET,EAAQ,MAAQ,EAClB,CACF,CAE6B,oBAI3B,OAAAoB,EAAA,EAAAC,EAQM,MARNC,EAQM,CANOC,EAAAvB,CAAA,GAAXoB,EAAA,EAAAC,EAIM,MAJNG,EAIM,CAAA,GAAAC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAA,CAHJC,EAEE,OAAA,CADA,MAAM,uGAAA,EAAuG,KAAA,EAAA,CAAA,eAGhGH,EAAAtB,CAAA,OAAjB0B,EAAwEC,EAAA,OAAvC,KAAK,SAAU,KAAML,EAAAtB,CAAA,CAAA"}